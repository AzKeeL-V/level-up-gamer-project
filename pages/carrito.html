<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - LEVEL-UP GAMER</title>
    
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/style.css" rel="stylesheet">
</head>

<body class="cart-page">
    <!-- Partículas flotantes de fondo -->
    <div class="floating-particles">
        <div class="stars"></div>
    </div>

    <!-- Agregando navbar completo -->
    <nav class="navbar navbar-expand-lg navbar-custom fixed-top" id="mainNavbar">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <!-- Cambiando icono de Bootstrap por imagen del hero -->
                <img src="../img/setup-inicio.jpg" alt="Level Up Gamer" class="navbar-brand-icon me-2">
                LEVEL-UP GAMER
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="bi bi-list text-white fs-4"></i>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="bi bi-house-fill me-1"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalogo.html">
                            <i class="bi bi-grid-3x3-gap me-1"></i>Catálogo
                        </a>
                    </li>
                    <!-- agregando enlace de blog que faltaba -->
                    <li class="nav-item">
                        <a class="nav-link" href="blogNoticias.html">
                            <i class="bi bi-newspaper me-1"></i>Blog
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contacto.html">
                            <i class="bi bi-envelope me-1"></i>Contacto
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center gap-3">
                    <!-- Agregando link al carrito antes del menú de usuario -->
                    <a href="carrito.html" class="btn btn-outline-primary btn-sm position-relative active">
                        <i class="bi bi-cart3 me-1"></i>Carrito
                        <span id="cartBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success d-none">
                            0
                        </span>
                    </a>
                    
                    <!-- Agregando div authButtons que se oculta cuando el usuario está logueado -->
                    <div id="authButtons" class="d-flex gap-2">
                        <a href="login.html" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesión
                        </a>
                        <a href="registro.html" class="btn btn-success btn-sm">
                            <i class="bi bi-person-plus me-1"></i>Registrarse
                        </a>
                    </div>
                    
                    <div id="userMenu" class="d-none">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" 
                                    type="button" data-bs-toggle="dropdown">
                                <div class="user-avatar">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                <span id="userName" class="d-none d-md-inline"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end user-dropdown-menu">
                                <!-- Nueva cabecera del dropdown con información del usuario -->
                                <li class="user-info-header">
                                    <div class="d-flex align-items-center gap-3 p-3">
                                        <div class="user-avatar-large">
                                            <i class="bi bi-person-fill"></i>
                                        </div>
                                        <div class="user-details">
                                            <div class="user-name-display" id="userNameDisplay"></div>
                                            <div class="d-flex align-items-center gap-3 mt-2">
                                                <div class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                    <span class="user-level-text">Nivel <span id="userLevel">1</span></span>
                                                </div>
                                                <div class="d-flex align-items-center gap-1">
                                                    <i class="bi bi-coin text-success"></i>
                                                    <span class="user-points-text"><span id="userPoints">0</span> pts</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <!-- Removed Mi Perfil and Mis Pedidos menu items as per request -->
                                <!-- Agregando opción de administrador que solo aparece para admins -->
                                <li id="adminMenuItem" class="d-none"><hr class="dropdown-divider"></li>
                                <li id="adminMenuLink" class="d-none">
                                    <a class="dropdown-item admin-panel-item" href="admin.html">
                                        <i class="bi bi-gear-fill me-2"></i>Panel de Administrador
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Ocultando el levelUpDisplay de la barra de navegación -->
                    <div id="levelUpDisplay" class="d-none" style="display: none !important;">
                        <div class="d-flex align-items-center gap-2">
                            <div class="level-badge">
                                <i class="bi bi-star-fill me-1"></i>
                                <span id="userLevelHidden">1</span>
                            </div>
                            <div class="text-white d-none d-lg-block">
                                <small class="d-block opacity-75">Puntos</small>
                                <strong id="userPointsHidden" class="text-primary">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenedor principal con fondo transparente -->
    <main class="cart-main">
        <div class="container-fluid px-4 px-md-5 py-5">
            <div class="row g-5">
                <!-- Lista de productos del carrito -->
                <div class="col-12 col-xl-8">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-5 gap-3">
                        <h1 class="text-white mb-0 h2 h-md-1">
                            <i class="bi bi-cart3 me-3 text-success"></i>
                            Tu carrito (<span id="cart-title-count">0</span> productos)
                        </h1>
                        <a href="catalogo.html" class="btn btn-outline-primary btn-lg px-4 py-2">
                            <i class="bi bi-arrow-left me-2"></i>
                            <span class="d-none d-sm-inline">Seguir comprando</span>
                            <span class="d-sm-none">Catálogo</span>
                        </a>
                    </div>

                    <!-- Contenedor de productos del carrito -->
                    <div id="cart-items-container" class="mb-4">
                        <!-- Los productos se cargarán dinámicamente aquí -->
                    </div>

                    <!-- Mensaje cuando el carrito está vacío -->
                    <div id="empty-cart-message" class="text-center py-5 my-5 bg-dark rounded-4 border border-secondary" style="display: none;">
                        <div class="mb-4">
                            <i class="bi bi-cart-x display-1 text-muted mb-4"></i>
                        </div>
                        <h3 class="text-white h4 h-md-3 mb-3">Tu carrito está vacío</h3>
                        <p class="text-secondary mb-4 fs-5">¡Agrega algunos productos increíbles!</p>
                        <a href="catalogo.html" class="btn btn-primary btn-lg px-5 py-3">
                            <i class="bi bi-grid me-2"></i>Ver Catálogo
                        </a>
                    </div>
                </div>

                <!-- Panel lateral de resumen -->
                <div class="col-12 col-xl-4">
                    <!-- Mejorado el resumen de pedido con mejor responsividad -->
                    <div class="cart-summary-card sticky-top shadow-lg" style="top: 120px;">
                        <div class="card-header bg-dark border-bottom border-secondary p-4">
                            <h4 class="card-title mb-0 d-flex align-items-center text-white">
                                <i class="bi bi-receipt me-3 text-primary fs-4"></i>
                                <span class="d-none d-sm-inline">Resumen de tu compra</span>
                                <span class="d-sm-none">Resumen</span>
                            </h4>
                        </div>
                        <div class="card-body bg-dark p-4">
                            <!-- Mejorado el layout del resumen con mejor espaciado -->
                            <div class="summary-details">
                                <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary">
                                    <span class="text-muted fs-6">Productos (<span id="summary-count">0</span>)</span>
                                    <span class="fw-medium fs-5" id="summary-subtotal">$0</span>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mb-5">
                                    <span class="fw-bold fs-4 text-white">Total</span>
                                    <span class="fw-bold text-success fs-3" id="summary-total">$0</span>
                                </div>
                            </div>

                            <!-- Mejorado el botón de checkout con mejor responsividad -->
                            <div class="d-grid gap-3 mb-4">
                                <button class="btn btn-success btn-lg py-3 fs-5" id="checkout-btn" disabled>
                                    <i class="bi bi-credit-card me-2"></i>
                                    <span class="d-none d-sm-inline">Continuar con el pago</span>
                                    <span class="d-sm-none">Pagar</span>
                                </button>
                            </div>

                            <!-- Mejorada la sección de información adicional -->
                            <div class="additional-info pt-4 border-top border-secondary">
                                <div class="d-flex align-items-start text-muted small mb-4">
                                    <i class="bi bi-shield-check me-3 text-success mt-1 flex-shrink-0 fs-5"></i>
                                    <span class="fs-6">Pago 100% seguro con encriptación SSL</span>
                                </div>
                                <div class="d-flex align-items-start text-muted small mb-4">
                                    <i class="bi bi-truck me-3 text-primary mt-1 flex-shrink-0 fs-5"></i>
                                    <span class="fs-6">Envío gratuito en compras sobre $50.000</span>
                                </div>
                                <div class="d-flex align-items-start text-muted small">
                                    <i class="bi bi-arrow-clockwise me-3 text-warning mt-1 flex-shrink-0 fs-5"></i>
                                    <span class="fs-6">30 días para devoluciones</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Agregando footer -->
    <footer class="footer-modern">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-4">
                    <h5>
                        <!-- Cambiando icono del footer también -->
                        <img src="../img/setup-inicio.jpg" alt="Level Up Gamer" class="footer-brand-icon me-2">
                        LEVEL-UP GAMER
                    </h5>
                    <p class="text-muted">
                        Tu destino gaming definitivo en Chile. Productos de calidad, 
                        precios competitivos y la mejor experiencia de compra.
                    </p>
                </div>
                
                <div class="col-lg-2 col-md-6">
                    <h6>Navegación</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="../index.html">Inicio</a></li>
                        <li class="mb-2"><a href="catalogo.html">Catálogo</a></li>
                        <li class="mb-2"><a href="blogNoticias.html">Blog</a></li>
                        <li class="mb-2"><a href="contacto.html">Contacto</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-2 col-md-6">
                    <h6>Mi Cuenta</h6>
                    <ul class="list-unstyled">
                        <!-- Corrigiendo rutas del footer también -->
                        <li class="mb-2"><a href="login.html">Iniciar Sesión</a></li>
                        <li class="mb-2"><a href="registro.html">Crear Cuenta</a></li>
                        <li class="mb-2"><a href="perfil.html">Mi Perfil</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-2 col-md-6">
                    <h6>Soporte</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#">Centro de Ayuda</a></li>
                        <li class="mb-2"><a href="#">Envíos</a></li>
                        <li class="mb-2"><a href="#">Devoluciones</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-2 col-md-6">
                    <h6>Síguenos</h6>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-muted fs-5"><i class="bi bi-facebook"></i></a>
                        <a href="#" class="text-muted fs-5"><i class="bi bi-instagram"></i></a>
                        <a href="#" class="text-muted fs-5"><i class="bi bi-twitter"></i></a>
                    </div>
                </div>
            </div>
            
            <hr class="my-4" style="border-color: var(--gaming-border);">
            
            <div class="text-center">
                <p class="text-muted mb-0">
                    &copy; 2024 LEVEL-UP GAMER. Todos los derechos reservados.
                </p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Agregando usuario.js antes de main.js para que las funciones estén disponibles -->
    <script src="../js/usuario.js"></script>
    <!-- Custom JS -->
    <script src="../js/main.js"></script>
    
    <!-- Mejorando el script de timing y debug para los enlaces de autenticación -->
    <script>
        // Debug básico para enlaces de autenticación (sin timing)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema de navegación iniciado');
            console.log('Ubicación actual:', window.location.href);
            
            // Encontrar enlaces de autenticación
            const loginLinks = document.querySelectorAll('a[href="login.html"]');
            const registerLinks = document.querySelectorAll('a[href="registro.html"]');
            
            console.log('Enlaces de login encontrados:', loginLinks.length);
            console.log('Enlaces de registro encontrados:', registerLinks.length);
            
            // Los enlaces funcionan normalmente sin interceptar clicks
            loginLinks.forEach((link, index) => {
                console.log(`Login link ${index + 1} configurado:`, link.href);
            });
            
            registerLinks.forEach((link, index) => {
                console.log(`Register link ${index + 1} configurado:`, link.href);
            });
            
            console.log('Enlaces de autenticación listos para navegación normal');
        });
    </script>
    
    <!-- Mejorado el JavaScript para mejor responsividad -->
    <script>
        // Variables globales
        let cart = [];

        // Cargar carrito desde localStorage al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando página de carrito');
            
            if (typeof checkUserSession === 'function') {
                checkUserSession();
            }
            
            loadCartFromStorage();
            updateCartDisplay();
        });

        function loadCartFromStorage() {
            const possibleKeys = ['levelup_cart', 'carrito', 'cart'];
            let cartLoaded = false;
            
            for (const key of possibleKeys) {
                const savedCart = localStorage.getItem(key);
                if (savedCart) {
                    try {
                        const parsedCart = JSON.parse(savedCart);
                        if (Array.isArray(parsedCart) && parsedCart.length > 0) {
                            cart = parsedCart;
                            console.log(`Carrito cargado desde ${key}:`, cart.length, 'items');
                            cartLoaded = true;
                            break;
                        }
                    } catch (error) {
                        console.error(`Error al parsear carrito desde ${key}:`, error);
                    }
                }
            }
            
            if (!cartLoaded) {
                console.log('No hay carrito guardado en ninguna fuente');
                cart = [];
            }
        }

        function saveCartToMultipleSources() {
            // Guardar en la clave principal
            localStorage.setItem('levelup_cart', JSON.stringify(cart));
            
            // Mantener compatibilidad con otras posibles claves
            const possibleCartKeys = ['carrito', 'cart'];
            possibleCartKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify(cart));
                }
            });
            
            console.log('Carrito guardado en múltiples fuentes:', cart.length, 'items');
        }

        function saveCart() {
            saveCartToMultipleSources();
        }

        // Actualizar visualización del carrito
        function updateCartDisplay() {
            console.log('Actualizando visualización del carrito');
            const cartContainer = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');
            const cartTitleCount = document.getElementById('cart-title-count');
            const cartBadge = document.getElementById('cartBadge');

            // Actualizar contadores
            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            console.log('Total de items:', totalItems);
            
            if (cartTitleCount) cartTitleCount.textContent = totalItems;
            if (cartBadge) {
                cartBadge.textContent = totalItems;
                cartBadge.classList.toggle('d-none', totalItems === 0);
            }

            if (cart.length === 0) {
                console.log('Carrito vacío, mostrando mensaje');
                cartContainer.style.display = 'none';
                emptyMessage.style.display = 'block';
                updateSummary();
                return;
            }

            console.log('Mostrando productos del carrito');
            cartContainer.style.display = 'block';
            emptyMessage.style.display = 'none';

            cartContainer.innerHTML = cart.map(item => {
                const imagePath = `../img/productos/${item.image}`;
                return `
                <div class="card mb-4 cart-item-card shadow-sm border-0 bg-dark" data-product-id="${item.id}">
                    <div class="card-body p-3 p-md-4">
                        <div class="cart-item-main d-flex flex-column flex-lg-row gap-3 gap-lg-4">
                            <!-- Sección Izquierda (mayor ancho): Imagen, título, descripción y subtotal -->
                            <div class="cart-item-left flex-grow-1 d-flex gap-3">
                                <!-- Imagen del producto -->
                                <div class="product-image-container flex-shrink-0" style="max-width: 120px;">
                                    <img src="${imagePath}"
                                         alt="${item.name}"
                                         class="img-fluid rounded-3 shadow-lg w-100"
                                         style="max-height: 100px; object-fit: cover;"
                                         onerror="this.src='../img/placeholder.svg'">
                                </div>

                                <!-- Información del producto y precio -->
                                <div class="product-info-price flex-grow-1 d-flex flex-column justify-content-between">
                                    <div class="product-info">
                                        <h6 class="card-title text-primary mb-1 fs-6 fw-bold">${item.brand || 'Gaming'}</h6>
                                        <h5 class="mb-1 fs-6 fs-md-5 text-white fw-bold">${item.name}</h5>
                                        <p class="text-muted mb-0 fs-6 d-none d-lg-block">${item.description || 'Producto gaming de alta calidad'}</p>
                                    </div>

                                    <!-- Precio (subtotal del ítem) -->
                                    <div class="price-info mt-2">
                                        <div class="text-success fw-bold fs-5 fs-md-4">$${(item.price * item.quantity).toLocaleString()}</div>
                                        <small class="text-muted d-block fs-6">Unitario: $${item.price.toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección Derecha (menor ancho): Controles reorganizados -->
                            <div class="cart-item-right flex-shrink-0 d-flex align-items-center justify-content-between gap-2" style="min-width: 140px;">
                                <!-- Botón eliminar (izquierda) -->
                                <button class="btn btn-outline-danger btn-sm px-2 py-2" onclick="removeFromCartPage('${item.id}')" title="Eliminar producto">
                                    <i class="bi bi-trash fs-6"></i>
                                </button>

                                <!-- Controles de cantidad (centro) -->
                                <div class="quantity-controls d-flex align-items-center gap-1">
                                    <button class="btn btn-outline-secondary btn-sm px-2" type="button" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">
                                        <i class="bi bi-dash fs-6"></i>
                                    </button>
                                    <span class="badge bg-primary fs-6 px-2 py-1">${item.quantity}</span>
                                    <button class="btn btn-outline-secondary btn-sm px-2" type="button" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">
                                        <i class="bi bi-plus fs-6"></i>
                                    </button>
                                </div>

                                <!-- Espacio vacío para balance (derecha) -->
                                <div style="width: 32px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            updateSummary();
        }

        // Actualizar resumen de compra
        function updateSummary() {
            const summaryCount = document.getElementById('summary-count');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryTotal = document.getElementById('summary-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (summaryCount) summaryCount.textContent = totalItems;
            if (summarySubtotal) summarySubtotal.textContent = `$${totalPrice.toLocaleString()}`;
            if (summaryTotal) summaryTotal.textContent = `$${totalPrice.toLocaleString()}`;

            // Habilitar/deshabilitar botón de checkout
            if (checkoutBtn) checkoutBtn.disabled = cart.length === 0;
        }

        function updateQuantity(productId, newQuantity) {
            console.log('Actualizando cantidad:', productId, newQuantity);
            if (newQuantity <= 0) {
                console.log('Eliminando producto:', productId);
                removeFromCartPage(productId);
                return;
            }

            let products = {};
            
            // Intentar cargar desde múltiples claves para máxima compatibilidad
            const possibleKeys = ['levelup_products', 'products', 'adminProducts'];
            let productsLoaded = false;
            
            for (const key of possibleKeys) {
                const storedProducts = localStorage.getItem(key);
                if (storedProducts) {
                    try {
                        const parsedProducts = JSON.parse(storedProducts);
                        // Validar si es un objeto o array y convertir apropiadamente
                        if (Array.isArray(parsedProducts)) {
                            // Convertir array a objeto usando code como clave
                            parsedProducts.forEach(product => {
                                if (product.code) {
                                    products[product.code] = product;
                                }
                            });
                        } else if (typeof parsedProducts === 'object' && parsedProducts !== null) {
                            products = parsedProducts;
                        }
                        
                        if (Object.keys(products).length > 0) {
                            console.log(`Productos cargados desde ${key}:`, Object.keys(products).length);
                            productsLoaded = true;
                            break;
                        }
                    } catch (error) {
                        console.error(`Error al parsear productos desde ${key}:`, error);
                    }
                }
            }
            
            if (!productsLoaded || Object.keys(products).length === 0) {
                console.error('No se pudieron cargar productos desde ninguna fuente');
                showNotification('Error: No se pueden validar productos. Recarga la página.', 'error');
                return;
            }
            
            console.log('Productos disponibles:', Object.keys(products).length);
            console.log('Buscando producto con ID:', productId);
            
            const product = products[productId] || 
                           Object.values(products).find(p => 
                               String(p.code) === String(productId) || 
                               String(p.id) === String(productId) ||
                               String(p.codigo) === String(productId)
                           );
            
            if (!product) {
                console.error('Producto no encontrado:', productId);
                console.log('Códigos disponibles:', Object.keys(products));
                console.log('IDs disponibles:', Object.values(products).map(p => p.id || p.code));
                showNotification('Error: Producto no encontrado para validar stock.', 'error');
                return;
            }

            console.log('Producto encontrado:', product.name, 'Stock disponible:', product.stock);

            const availableStock = parseInt(product.stock) || 0;
            if (availableStock <= 0) {
                console.log('Producto sin stock disponible');
                showNotification(`${product.name} está agotado`, 'error');
                return;
            }
            
            if (newQuantity > availableStock) {
                console.log('Stock insuficiente. Solicitado:', newQuantity, 'Disponible:', availableStock);
                showNotification(`Solo hay ${availableStock} unidades disponibles de ${product.name}`, 'warning');
                return;
            }

            const itemIndex = cart.findIndex(item => 
                String(item.id) === String(productId) || 
                String(item.code) === String(productId)
            );
            
            if (itemIndex !== -1) {
                cart[itemIndex].quantity = newQuantity;
                console.log('Cantidad actualizada exitosamente:', cart[itemIndex]);
                
                saveCartToMultipleSources();
                updateCartDisplay();
                
                // También actualizar el carrito global si existe la función
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge();
                }
                showNotification('Cantidad actualizada', 'success');
            } else {
                console.error('Item no encontrado en carrito:', productId);
                console.log('Items en carrito:', cart.map(item => ({id: item.id, code: item.code})));
                showNotification('Error: Item no encontrado en carrito', 'error');
            }
        }

        // Función para guardar carrito en múltiples fuentes
        function saveCartToMultipleSources() {
            // Guardar en la clave principal
            localStorage.setItem('levelup_cart', JSON.stringify(cart));
            
            // Mantener compatibilidad con otras posibles claves
            const possibleCartKeys = ['carrito', 'cart'];
            possibleCartKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify(cart));
                }
            });
            
            console.log('Carrito guardado en múltiples fuentes:', cart.length, 'items');
        }

        function saveCart() {
            saveCartToMultipleSources();
        }

        function loadCartFromStorage() {
            const possibleKeys = ['levelup_cart', 'carrito', 'cart'];
            let cartLoaded = false;
            
            for (const key of possibleKeys) {
                const savedCart = localStorage.getItem(key);
                if (savedCart) {
                    try {
                        const parsedCart = JSON.parse(savedCart);
                        if (Array.isArray(parsedCart) && parsedCart.length > 0) {
                            cart = parsedCart;
                            console.log(`Carrito cargado desde ${key}:`, cart.length, 'items');
                            cartLoaded = true;
                            break;
                        }
                    } catch (error) {
                        console.error(`Error al parsear carrito desde ${key}:`, error);
                    }
                }
            }
            
            if (!cartLoaded) {
                console.log('No hay carrito guardado en ninguna fuente');
                cart = [];
            }
        }

        // Eliminar producto del carrito
        function removeFromCartPage(productId) {
            console.log('Eliminando producto:', productId);
            const initialLength = cart.length;
            
            cart = cart.filter(item => 
                String(item.id) !== String(productId) && 
                String(item.code) !== String(productId)
            );
            
            if (cart.length === initialLength) {
                console.error('No se pudo eliminar el producto:', productId);
                console.log('Items en carrito:', cart.map(item => ({id: item.id, code: item.code})));
                showNotification('Error al eliminar producto', 'error');
                return;
            }
            
            saveCartToMultipleSources();
            updateCartDisplay();
            
            // También actualizar el carrito global si existe la función
            if (typeof updateCartBadge === 'function') {
                updateCartBadge();
            }
            
            showNotification('Producto eliminado del carrito', 'success');
        }

        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            let iconClass = 'bi-check-circle-fill';
            let bgClass = 'success';
            
            if (type === 'warning') {
                iconClass = 'bi-exclamation-triangle-fill';
                bgClass = 'warning';
            }
            if (type === 'error') {
                iconClass = 'bi-x-circle-fill';
                bgClass = 'danger';
            }
            
            toast.className = `toast align-items-center text-bg-${bgClass} border-0`;
            toast.setAttribute('role', 'alert');
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            toast.innerHTML = ` 
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="${iconClass} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            // Agregar al DOM
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Remover del DOM después de que se oculte
            toast.addEventListener('hidden.bs.toast', () => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            });
        }

        // Manejar checkout
        document.addEventListener('DOMContentLoaded', function() {
            const checkoutBtn = document.getElementById('checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function() {
                    if (cart.length === 0) {
                        showNotification('El carrito está vacío', 'warning');
                        return;
                    }
                    
                    const levelupSession = localStorage.getItem('levelup_session') || sessionStorage.getItem('levelup_session');
                    let userData = null;
                    
                    if (levelupSession) {
                        userData = JSON.parse(levelupSession);
                    }
                    
                    console.log('=== VALIDACIÓN DE ROL EN CARRITO ===');
                    console.log('Datos de usuario para validación:', userData);
                    console.log('userData.isAdmin:', userData?.isAdmin, 'tipo:', typeof userData?.isAdmin);
                    
                    // Solo considerar administrador si explícitamente isAdmin es true
                    const isAdmin = userData && userData.isAdmin === true;
                    
                    console.log('Resultado validación - ¿Es administrador?:', isAdmin);
                    
                    if (isAdmin) {
                        console.log('✅ ADMINISTRADOR DETECTADO - Redirigiendo a opciones de envío para vendedor');
                        window.location.href = '../components/opciones-envio-vendedor.html';
                    } else {
                        console.log('👤 CLIENTE DETECTADO - Redirigiendo a checkout normal');
                        window.location.href = 'checkout.html';
                    }
                    
                    console.log('=== FIN VALIDACIÓN DE ROL ===');
                });
            }
        });
    </script>
</body>
</html>
